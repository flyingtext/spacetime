{% extends "base.html" %}
{% block title %}{{ _('%(action)s Post', action=action) }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@9/dist/jsoneditor.min.css" />
<h1>{{ _('%(action)s Post', action=action) }}</h1>
<form method="post" id="post-form">
  <div class="mb-3">
    <label for="title">{{ _('Title') }}</label>
    <input name="title" id="title" class="form-control" placeholder="{{ _('Title') }}" value="{{ post.title if post else prefill_title or '' }}">
  </div>
  <div class="mb-3">
    <label for="body">{{ _('Body') }}</label>
    <textarea name="body" id="body" class="form-control" rows="20" cols="50">{{ post.body if post else prefill_body or '' }}</textarea>
  </div>
  <div id="preview"></div>
  {% if post %}
  <div class="mb-3">
    <button type="button" id="suggest-citations" class="btn btn-secondary">{{ _('Suggest Citation') }}</button>
  </div>
  <div id="citation-results"></div>
  {% endif %}
  <div class="mb-3">
    <label for="path">{{ _('Path (e.g., docs/start)') }}</label>
    <input name="path" id="path" class="form-control" placeholder="{{ _('Path (e.g., docs/start)') }}" value="{{ post.path if post else '' }}">
  </div>
  <div class="mb-3">
    <label for="language">{{ _('Language code') }}</label>
    <input name="language" id="language" class="form-control" placeholder="{{ _('Language code') }}" value="{{ post.language if post else 'en' }}">
  </div>
  <div class="mb-3">
    <label for="tags">{{ _('Comma separated tags') }}</label>
    <input name="tags" id="tags" class="form-control" placeholder="{{ _('Comma separated tags') }}" value="{{ tags if tags else '' }}">
  </div>
  <details id="location-section" class="mb-3">
    <summary>{{ _('Location') }}</summary>
    <label for="address-input">{{ _('Address') }}</label>
    <div class="row g-2">
      <div class="col-md-6">
        <input id="address-input" class="form-control mb-2" placeholder="{{ _('Address') }}">
        <button type="button" id="find-coordinates" class="btn btn-secondary">{{ _('Find Coordinates') }}</button>
      </div>
      <div class="col-md-6">
        <div id="map" style="height:300px"></div>
      </div>
    </div>
    <input type="hidden" name="lat" id="lat" value="{{ lat or '' }}">
    <input type="hidden" name="lon" id="lon" value="{{ lon or '' }}">
    <p id="geocode-error" class="error-message"></p>
  </details>
  <details class="mb-3">
    <summary>{{ _('Post metadata (JSON)') }}</summary>
    <textarea name="metadata" id="metadata" class="form-control d-none" placeholder="{{ _('Post metadata (JSON)') }}" rows="5" cols="50">{{ metadata if metadata else '' }}</textarea>
    <div id="metadata_editor" style="height: 200px;"></div>
  </details>
  <details class="mb-3">
    <summary>{{ _('Your metadata (JSON)') }}</summary>
    <textarea name="user_metadata" id="user_metadata" class="form-control d-none" placeholder="{{ _('Your metadata (JSON)') }}" rows="5" cols="50">{{ user_metadata if user_metadata else '' }}</textarea>
    <div id="user_metadata_editor" style="height: 200px;"></div>
  </details>
  <div class="mb-3">
    <label for="comment">{{ _('Edit summary') }}</label>
    <input name="comment" id="comment" class="form-control" placeholder="{{ _('Edit summary') }}">
  </div>
  {% if request_id %}<input type="hidden" name="request_id" value="{{ request_id }}">{% endif %}
  <div class="mb-3">
    <button type="submit" class="btn btn-primary">{{ action }}</button>
  </div>
</form>
{% if post and current_user.is_authenticated and (current_user.id == post.author_id or current_user.is_admin()) %}
<form action="{{ url_for('delete_post', post_id=post.id) }}" method="post" class="mt-3">
  <button type="submit" class="btn btn-danger">{{ _('Delete') }}</button>
</form>
{% endif %}
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsoneditor@9/dist/jsoneditor.min.js"></script>
<script>
const bodyInput = document.querySelector('textarea[name="body"]');
const previewEl = document.getElementById('preview');
const formEl = document.getElementById('post-form');
formEl.addEventListener('keydown', function (e) {
  if (e.key === 'Enter') {
    if (e.target.id === 'address-input') {
      e.preventDefault();
      document.getElementById('find-coordinates').click();
    } else if (e.target.tagName !== 'TEXTAREA') {
      e.preventDefault();
    }
  }
});

let metaEditor;
try {
  const metaTextarea = document.getElementById('metadata');
  metaEditor = new JSONEditor(document.getElementById('metadata_editor'), {mode: 'code'});
  let initialMeta = {};
  if (metaTextarea.value.trim()) {
    try { initialMeta = JSON.parse(metaTextarea.value); } catch (e) {}
  }
  metaEditor.set(initialMeta);
  metaEditor.on('change', () => {
    try { metaTextarea.value = JSON.stringify(metaEditor.get()); } catch (e) {}
  });
} catch (e) { console.error(e); }

let userMetaEditor;
try {
  const userMetaTextarea = document.getElementById('user_metadata');
  userMetaEditor = new JSONEditor(document.getElementById('user_metadata_editor'), {mode: 'code'});
  let initialUserMeta = {};
  if (userMetaTextarea.value.trim()) {
    try { initialUserMeta = JSON.parse(userMetaTextarea.value); } catch (e) {}
  }
  userMetaEditor.set(initialUserMeta);
  userMetaEditor.on('change', () => {
    try { userMetaTextarea.value = JSON.stringify(userMetaEditor.get()); } catch (e) {}
  });
} catch (e) { console.error(e); }

function updatePreview() {
  fetch('{{ url_for('markdown_preview') }}', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text: bodyInput.value})
  }).then(r => r.json()).then(data => {
    previewEl.innerHTML = data.html || '';
  });
}
bodyInput.addEventListener('input', updatePreview);
updatePreview();

const map = L.map('map').setView([0, 0], 2);
const darkUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
const lightUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const isDark = () => document.body.classList.contains('dark-mode') || localStorage.getItem('theme') === 'dark';
const tiles = L.tileLayer(isDark() ? darkUrl : lightUrl, {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
const updateTiles = () => {
  tiles.setUrl(isDark() ? darkUrl : lightUrl);
};
const themeToggle = document.getElementById('theme-toggle');
if (themeToggle) {
  themeToggle.addEventListener('click', () => setTimeout(updateTiles, 0));
}
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);
const drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: { polygon:false, polyline:false, rectangle:false, circle:false, circlemarker:false }
});
map.addControl(drawControl);
const locationSection = document.getElementById('location-section');
locationSection.addEventListener('toggle', () => {
  if (locationSection.open) {
    setTimeout(() => map.invalidateSize(), 0);
  }
});
setTimeout(() => map.invalidateSize(), 0);

const latField = document.getElementById('lat');
const lonField = document.getElementById('lon');
const initLat = parseFloat(latField.value);
const initLon = parseFloat(lonField.value);
if (!isNaN(initLat) && !isNaN(initLon)) {
  L.marker([initLat, initLon]).addTo(drawnItems);
  map.setView([initLat, initLon], 13);
}

map.on(L.Draw.Event.CREATED, function (e) {
  drawnItems.clearLayers();
  const layer = e.layer;
  drawnItems.addLayer(layer);
  const latlng = layer.getLatLng();
  latField.value = latlng.lat;
  lonField.value = latlng.lng;
});

document.getElementById('find-coordinates').addEventListener('click', function () {
  const addr = document.getElementById('address-input').value;
  fetch('{{ url_for('geocode') }}?address=' + encodeURIComponent(addr))
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        document.getElementById('geocode-error').textContent = data.error;
      } else {
        document.getElementById('geocode-error').textContent = '';
        latField.value = data.lat;
        lonField.value = data.lon;
        drawnItems.clearLayers();
        L.marker([data.lat, data.lon]).addTo(drawnItems);
        map.setView([data.lat, data.lon], 13);
      }
    })
    .catch(() => {
      document.getElementById('geocode-error').textContent = '{{ _('Geocoding failed') }}';
    });
});
</script>
{% if post %}
<script>
document.getElementById('suggest-citations').addEventListener('click', function () {
  const body = document.querySelector('textarea[name="body"]').value;
  const lines = body.split('\n').filter(l => l.trim());
  const container = document.getElementById('citation-results');
  container.innerHTML = '';
  lines.forEach(line => {
    const lineSection = document.createElement('div');
    container.appendChild(lineSection);
    fetch('{{ url_for('citation_suggest_line') }}', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({line})
    }).then(r => r.json()).then(data => {
      if (!data.results) return;
      for (const [sentence, cands] of Object.entries(data.results)) {
        const section = document.createElement('div');
        const p = document.createElement('p');
        p.textContent = sentence;
        section.appendChild(p);
        cands.forEach(c => {
          const pre = document.createElement('pre');
          pre.textContent = c.text;
          const btn = document.createElement('button');
          btn.textContent = '{{ _('Save') }}';
          btn.addEventListener('click', () => {
            const fd = new FormData();
            fd.append('citation_text', c.text);
            fetch('{{ url_for('new_citation', post_id=post.id) }}', {
              method: 'POST',
              body: fd
            }).then(() => { btn.disabled = true; });
          });
          const div = document.createElement('div');
          div.appendChild(pre);
          div.appendChild(btn);
          section.appendChild(div);
        });
        lineSection.appendChild(section);
      }
    });
  });
});
</script>
{% endif %}
{% endblock %}

