{% extends "base.html" %}
{% block title %}{{ _('%(action)s Post', action=action) }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@9/dist/jsoneditor.min.css" />
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css" />
<h1>{{ _('%(action)s Post', action=action) }}</h1>
<form method="post" id="post-form">
  <div class="mb-3">
    <label for="title">{{ _('Title') }}</label>
    <input name="title" id="title" class="form-control" placeholder="{{ _('Title') }}" value="{{ post.title if post else prefill_title or '' }}">
  </div>
  <div class="mb-3">
    <label for="body">{{ _('Body') }}</label>
    <div class="row">
      <div class="col-md-6 mb-3 mb-md-0">
        <textarea name="body" id="body" class="form-control" rows="20" cols="50">{{ post.body if post else prefill_body or '' }}</textarea>
      </div>
      <div class="col-md-6">
        <div id="preview" class="border p-2"></div>
      </div>
    </div>
  </div>
  
  <div class="mb-3">
    <label for="path">{{ _('Path (e.g., docs/start)') }}</label>
    <input name="path" id="path" class="form-control" placeholder="{{ _('Path (e.g., docs/start)') }}" value="{{ post.path if post else prefill_path or '' }}">
  </div>
  {% set selected_language = post.language if post else prefill_language or 'en' %}
  <div class="mb-3">
    <label>{{ _('Language code') }}</label>
    {% for lang in languages %}
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="language" id="language-{{ lang }}" value="{{ lang }}" {% if lang == selected_language %}checked{% endif %}>
      <label class="form-check-label" for="language-{{ lang }}">{{ lang }}</label>
    </div>
    {% endfor %}
  </div>
  <div class="mb-3">
    <label for="tags">{{ _('Comma separated tags') }}</label>
    <input name="tags" id="tags" class="form-control" placeholder="{{ _('Comma separated tags') }}" value="{{ tags if tags else '' }}">
  </div>
  <details id="location-section" class="mb-3">
    <summary>{{ _('Location') }}</summary>
    <label for="address-input">{{ _('Address') }}</label>
    <div class="row g-2">
      <div class="col-md-6">
        <input id="address-input" class="form-control mb-2" placeholder="{{ _('Address') }}">
        <button type="button" id="find-coordinates" class="btn btn-secondary">{{ _('Find Coordinates') }}</button>
      </div>
      <div class="col-md-6">
        <div id="map" style="height:300px"></div>
      </div>
    </div>
    <input type="hidden" name="lat" id="lat" value="{{ lat or '' }}">
    <input type="hidden" name="lon" id="lon" value="{{ lon or '' }}">
    <p id="geocode-error" class="error-message"></p>
  </details>
  <details class="mb-3">
    <summary>{{ _('Post metadata (JSON)') }}</summary>
    <textarea name="metadata" id="metadata" class="form-control form-control-sm d-none" placeholder="{{ _('Post metadata (JSON)') }}" rows="3" cols="40">{{ metadata if metadata else '' }}</textarea>
    <div id="metadata_editor" style="height: 100px;"></div>
  </details>
  <details class="mb-3">
    <summary>{{ _('Your metadata (JSON)') }}</summary>
    <textarea name="user_metadata" id="user_metadata" class="form-control form-control-sm d-none" placeholder="{{ _('Your metadata (JSON)') }}" rows="3" cols="40">{{ user_metadata if user_metadata else '' }}</textarea>
    <div id="user_metadata_editor" style="height: 100px;"></div>
  </details>
  <div class="mb-3">
    <label for="comment">{{ _('Edit summary') }}</label>
    <input name="comment" id="comment" class="form-control" placeholder="{{ _('Edit summary') }}">
  </div>
  {% if request_id %}<input type="hidden" name="request_id" value="{{ request_id }}">{% endif %}
  
</form>
<div class="d-flex justify-content-end gap-2 mt-3">
  <button type="submit" class="btn btn-primary" form="post-form">{{ action }}</button>
  {% if post and current_user.is_authenticated and (current_user.id == post.author_id or current_user.is_admin()) %}
  <form action="{{ url_for('delete_post', post_id=post.id) }}" method="post">
    <button type="submit" class="btn btn-danger">{{ _('Delete') }}</button>
  </form>
  {% endif %}
</div>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsoneditor@9/dist/jsoneditor.min.js"></script>
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<script>
const bodyEl = document.getElementById('body');
let easyMDE;
try {
  easyMDE = new EasyMDE({ element: bodyEl });
} catch (e) {
  console.error(e);
}
const previewEl = document.getElementById('preview');
const formEl = document.getElementById('post-form');
formEl.addEventListener('keydown', function (e) {
  if (e.key === 'Enter') {
    if (e.target.id === 'address-input') {
      e.preventDefault();
      document.getElementById('find-coordinates').click();
    } else if (e.target.tagName !== 'TEXTAREA') {
      e.preventDefault();
    }
  }
});

const metaTextarea = document.getElementById('metadata');
let metaEditor;
let initialMeta = {};
try {
  metaEditor = new JSONEditor(document.getElementById('metadata_editor'), {mode: 'code'});
  if (metaTextarea.value.trim()) {
    try { initialMeta = JSON.parse(metaTextarea.value); } catch (e) {}
  }
  metaEditor.set(initialMeta);
  metaEditor.on('change', () => {
    try { metaTextarea.value = JSON.stringify(metaEditor.get()); } catch (e) {}
  });
} catch (e) { console.error(e); }

let userMetaEditor;
try {
  const userMetaTextarea = document.getElementById('user_metadata');
  userMetaEditor = new JSONEditor(document.getElementById('user_metadata_editor'), {mode: 'code'});
  let initialUserMeta = {};
  if (userMetaTextarea.value.trim()) {
    try { initialUserMeta = JSON.parse(userMetaTextarea.value); } catch (e) {}
  }
  userMetaEditor.set(initialUserMeta);
  userMetaEditor.on('change', () => {
    try { userMetaTextarea.value = JSON.stringify(userMetaEditor.get()); } catch (e) {}
  });
} catch (e) { console.error(e); }

function updatePreview() {
  fetch('{{ url_for('markdown_preview') }}', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      text: easyMDE ? easyMDE.value() : bodyEl.value,
      language: document.querySelector('input[name="language"]:checked').value
    }),
    noSpinner: true
  }).then(r => r.json()).then(data => {
    previewEl.innerHTML = data.html || '';
    if (window.MathJax && window.MathJax.typesetPromise) {
      MathJax.typesetPromise([previewEl]);
    }
  });
}
if (easyMDE && easyMDE.codemirror) {
  easyMDE.codemirror.on('change', updatePreview);
} else {
  bodyEl.addEventListener('input', updatePreview);
}
document.querySelectorAll('input[name="language"]').forEach(el => {
  el.addEventListener('change', updatePreview);
});
updatePreview();

const map = L.map('map').setView([0, 0], 2);
const darkUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
const lightUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const isDark = () => document.body.classList.contains('dark-mode') || localStorage.getItem('theme') !== 'light';
const tiles = L.tileLayer(isDark() ? darkUrl : lightUrl, {

  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);
const drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: { polygon:false, polyline:false, rectangle:false, circle:false, circlemarker:false }
});
map.addControl(drawControl);
const locationSection = document.getElementById('location-section');
locationSection.addEventListener('toggle', () => {
  if (locationSection.open) {
    setTimeout(() => map.invalidateSize(), 0);
  }
});
setTimeout(() => map.invalidateSize(), 0);

const latField = document.getElementById('lat');
const lonField = document.getElementById('lon');

function updateLocations() {
  const locs = [];
  let first = null;
  drawnItems.eachLayer(layer => {
    const ll = layer.getLatLng();
    locs.push({lat: ll.lat, lon: ll.lng});
    if (!first) first = ll;
  });
  if (first) {
    latField.value = first.lat;
    lonField.value = first.lng;
  } else {
    latField.value = '';
    lonField.value = '';
  }
  try {
    const data = metaEditor.get();
    data.locations = locs;
    metaEditor.set(data);
    try { metaTextarea.value = JSON.stringify(metaEditor.get()); } catch (e) {}
  } catch (e) {}
}

const initLat = parseFloat(latField.value);
const initLon = parseFloat(lonField.value);
let initialLocations = Array.isArray(initialMeta.locations) ? initialMeta.locations : [];
if (initialLocations.length) {
  initialLocations.forEach(loc => {
    if (loc.lat !== undefined && loc.lon !== undefined) {
      L.marker([loc.lat, loc.lon]).addTo(drawnItems);
    }
  });
  const first = initialLocations[0];
  latField.value = first.lat;
  lonField.value = first.lon;
  map.setView([first.lat, first.lon], 13);
} else if (!isNaN(initLat) && !isNaN(initLon)) {
  L.marker([initLat, initLon]).addTo(drawnItems);
  map.setView([initLat, initLon], 13);
}

map.on(L.Draw.Event.CREATED, function (e) {
  drawnItems.addLayer(e.layer);
  updateLocations();
});
map.on(L.Draw.Event.DELETED, updateLocations);
map.on(L.Draw.Event.EDITED, updateLocations);

document.getElementById('find-coordinates').addEventListener('click', function () {
  const addr = document.getElementById('address-input').value;
  fetch('{{ url_for('geocode') }}?address=' + encodeURIComponent(addr))
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        document.getElementById('geocode-error').textContent = data.error;
      } else {
        document.getElementById('geocode-error').textContent = '';
        latField.value = data.lat;
        lonField.value = data.lon;
        drawnItems.addLayer(L.marker([data.lat, data.lon]));
        map.setView([data.lat, data.lon], 13);
        updateLocations();
      }
    })
    .catch(() => {
      document.getElementById('geocode-error').textContent = '{{ _('Geocoding failed') }}';
    });
});
</script>
{% endblock %}

