{% extends "base.html" %}
{% block title %}{{ _('%(action)s Post', action=action) }}{% endblock %}
{% block content %}
<h1>{{ _('%(action)s Post', action=action) }}</h1>
<form method="post">
  <p><input name="title" placeholder="{{ _('Title') }}" value="{{ post.title if post else prefill_title or '' }}"></p>
  <p><textarea name="body" rows="10" cols="50">{{ post.body if post else prefill_body or '' }}</textarea></p>
  <div id="preview"></div>
  {% if post %}
  <p><button type="button" id="suggest-citations">{{ _('Suggest Citation') }}</button></p>
  <div id="citation-results"></div>
  {% endif %}
  <p><input name="path" placeholder="{{ _('Path (e.g., docs/start)') }}" value="{{ post.path if post else '' }}"></p>
  <p><input name="language" placeholder="{{ _('Language code') }}" value="{{ post.language if post else 'en' }}"></p>
  <p><input name="tags" placeholder="{{ _('Comma separated tags') }}" value="{{ tags if tags else '' }}"></p>
  <p><textarea name="metadata" placeholder="{{ _('Post metadata (JSON)') }}" rows="5" cols="50">{{ metadata if metadata else '' }}</textarea></p>
  <p><textarea name="user_metadata" placeholder="{{ _('Your metadata (JSON)') }}" rows="5" cols="50">{{ user_metadata if user_metadata else '' }}</textarea></p>
  {% if request_id %}<input type="hidden" name="request_id" value="{{ request_id }}">{% endif %}
  <p><button type="submit">{{ action }}</button></p>
</form>
{% if post and current_user.is_authenticated and (current_user.id == post.author_id or current_user.is_admin()) %}
<form action="{{ url_for('delete_post', post_id=post.id) }}" method="post" style="margin-top:1em">
  <button type="submit">{{ _('Delete') }}</button>
</form>
{% endif %}
<script>
const bodyInput = document.querySelector('textarea[name="body"]');
const previewEl = document.getElementById('preview');
function updatePreview() {
  fetch('{{ url_for('markdown_preview') }}', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text: bodyInput.value})
  }).then(r => r.json()).then(data => {
    previewEl.innerHTML = data.html || '';
  });
}
bodyInput.addEventListener('input', updatePreview);
updatePreview();
</script>
{% if post %}
<script>
document.getElementById('suggest-citations').addEventListener('click', function () {
  const body = document.querySelector('textarea[name="body"]').value;
  fetch('{{ url_for('citation_suggest') }}', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text: body})
  }).then(r => r.json()).then(data => {
    const container = document.getElementById('citation-results');
    container.innerHTML = '';
    if (!data.results) return;
    for (const [sentence, cands] of Object.entries(data.results)) {
      const section = document.createElement('div');
      const p = document.createElement('p');
      p.textContent = sentence;
      section.appendChild(p);
      cands.forEach(c => {
        const pre = document.createElement('pre');
        pre.textContent = c.text;
        const btn = document.createElement('button');
        btn.textContent = '{{ _('Save') }}';
        btn.addEventListener('click', () => {
          const fd = new FormData();
          fd.append('citation_text', c.text);
          fetch('{{ url_for('new_citation', post_id=post.id) }}', {
            method: 'POST',
            body: fd
          }).then(() => { btn.disabled = true; });
        });
        const div = document.createElement('div');
        div.appendChild(pre);
        div.appendChild(btn);
        section.appendChild(div);
      });
      container.appendChild(section);
    }
  });
});
</script>
{% endif %}
{% endblock %}
