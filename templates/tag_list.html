{% extends "base.html" %}
{% block title %}{{ _('Tags') }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<style>
  .container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
  #tag-info-content a { text-decoration: none; }
  #tag-info-content h3 a { text-decoration: underline; }
  .marker-cluster {
    border-radius: 30px;
  }
  .marker-cluster div {
    width: 50px;
    height: 50px;
    margin-left: 5px;
    margin-top: 5px;
    border-radius: 25px;
    font: 16px "Helvetica Neue", Arial, Helvetica, sans-serif;
  }
  .marker-cluster span {
    line-height: 50px;
  }
  .tag-icon {
    margin: 10px;
  }
</style>
<div id="tag-info" class="border position-relative" style="display:none">
  <div id="tag-info-handle" class="bg-light border-bottom" style="cursor:move; height:20px;"></div>
  <button id="tag-info-close" type="button" class="btn-close" aria-label="Close" style="position:absolute; top:8px; right:8px;"></button>
  <div id="tag-info-content" class="p-3"></div>
</div>
<input type="search" id="tag-search" class="form-control" placeholder="{{ _('Search tags...') }}">
<div id="tag-map"></div>
<div class="container mt-4">
  {% for info in tag_info %}
    <div class="tag-card">
      <h5>
        <a href="{{ url_for('tag_filter', name=info.tag.name) }}" class="tag-pill">{{ info.tag.name }}</a>
      </h5>
      {% if info.top_posts %}
        <ul>
          {% for post, views in info.top_posts %}
            <li>
              <a href="{{ url_for('document', language=post.language, doc_path=post.path) }}">{{ post.display_title }}</a>
              <span class="small text-muted">· {{ views }} {{ _('views') }}</span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  {% endfor %}
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
const navHeight = document.querySelector('nav').offsetHeight;
const mapDiv = document.getElementById('tag-map');
mapDiv.style.position = 'fixed';
mapDiv.style.top = navHeight + 'px';
mapDiv.style.left = '0';
mapDiv.style.right = '0';
mapDiv.style.bottom = '0';

const infoDiv = document.getElementById('tag-info');
const infoContent = document.getElementById('tag-info-content');
const closeBtn = document.getElementById('tag-info-close');
const dragHandle = document.getElementById('tag-info-handle');
const searchInput = document.getElementById('tag-search');

searchInput.style.position = 'fixed';
searchInput.style.top = navHeight + 10 + 'px';
searchInput.style.left = '10px';
searchInput.style.zIndex = '1000';
searchInput.style.maxWidth = '250px';

function positionInfoDiv(){
  if(infoDiv.dataset.dragged === 'true') return;
  infoDiv.style.position = 'fixed';
  infoDiv.style.top = navHeight + 'px';
  infoDiv.style.background = 'rgba(255,255,255,0.9)';
  infoDiv.style.zIndex = '1000';
  infoDiv.style.overflowY = 'auto';
  infoDiv.style.color = '#000';
  if(window.innerWidth >= 768){
    const width = 400;
    infoDiv.style.width = width + 'px';
    const mapRect = mapDiv.getBoundingClientRect();
    infoDiv.style.left = (mapRect.right - width - 10) + 'px';
    infoDiv.style.right = 'auto';
    infoDiv.style.maxHeight = '50vh';
    infoDiv.style.border = '1px solid rgba(0,0,0,0.1)';
    infoDiv.style.borderRadius = '0.5rem';
    infoDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
  } else {
    infoDiv.style.left = '0';
    infoDiv.style.right = '0';
    infoDiv.style.width = 'auto';
    infoDiv.style.maxHeight = '30vh';
    infoDiv.style.border = 'none';
    infoDiv.style.borderRadius = '0';
    infoDiv.style.boxShadow = 'none';
  }
}

positionInfoDiv();
window.addEventListener('resize', positionInfoDiv);

closeBtn.addEventListener('click', () => {
  infoDiv.style.display = 'none';
});

let isDragging = false;
let offsetX = 0;
let offsetY = 0;

dragHandle.addEventListener('mousedown', (e) => {
  isDragging = true;
  const rect = infoDiv.getBoundingClientRect();
  offsetX = e.clientX - rect.left;
  offsetY = e.clientY - rect.top;
  infoDiv.dataset.dragged = 'true';
  document.addEventListener('mousemove', onMouseMove);
});

document.addEventListener('mouseup', () => {
  isDragging = false;
  document.removeEventListener('mousemove', onMouseMove);
});

function onMouseMove(e){
  if(!isDragging) return;
  infoDiv.style.left = (e.clientX - offsetX) + 'px';
  infoDiv.style.top = (e.clientY - offsetY) + 'px';
  infoDiv.style.right = 'auto';
}
const tagLocations = {{ tag_locations_json|safe }};
const tagPosts = {{ tag_posts_json|safe }};
const map = L.map('tag-map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
function createIcon(name){
  const ctx = document.createElement('canvas').getContext('2d');
  ctx.font = '16px sans-serif';
  const textWidth = Math.ceil(ctx.measureText(name).width);
  const padding = 30;
  const width = textWidth + padding * 2;
  const height = 50;
  const svg = `\
  <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
    <rect x="${padding / 2}" y="5" width="${width - padding}" height="${height - 10}" fill="#001f3f" fill-opacity="0.5" stroke-width="0" />
    <text x="${width / 2}" y="35" font-size="16" font-weight="bold" text-anchor="middle" fill="#fff">${name}</text>
  </svg>`;
  return L.divIcon({html: svg, className: 'tag-icon', iconSize:[width,height], iconAnchor:[width/2,height]});
}
const markers = L.markerClusterGroup({
  spiderLegPolylineOptions: {
    color: '#0d6efd',
    weight: 1,
    opacity: 1
  },
  maxClusterRadius: 120,
  // Increase spiderfy distance so large tag icons do not overlap
  spiderfyDistanceMultiplier: 3.5,
  iconCreateFunction: function(cluster){
    const count = cluster.getChildCount();
    let c = ' marker-cluster-small';
    if(count >= 10 && count < 100){
      c = ' marker-cluster-medium';
    } else if(count >= 100){
      c = ' marker-cluster-large';
    }
    return L.divIcon({
      html: `<div><span>${count}</span></div>`,
      className: 'marker-cluster' + c,
      iconSize: L.point(60,60)
    });
  }
});
const allMarkers = [];
  tagLocations.forEach(t => {
    const marker = L.marker([t.lat, t.lon], {icon: createIcon(t.name)});
    marker.on('click', () => {
      const info = tagPosts.find(tp => tp.tag === t.name);
      if(info){
        let html = `<h3><a href="${t.url}">${t.name}</a></h3>`;
        info.posts.forEach(p => {
          html += `<a href="${p.url}" class="d-block mb-2">`;
          html += `<div>${p.title}</div>`;
          html += `<div class="small text-muted">${p.author} · ${p.views} views</div>`;
          html += `<p class="small mb-0">${p.snippet}</p>`;
          html += `</a>`;
        });
        infoContent.innerHTML = html;
        infoDiv.style.display = 'block';
        infoDiv.dataset.dragged = 'false';
        positionInfoDiv();
      }
    });
    marker.tagName = t.name;
    markers.addLayer(marker);
    allMarkers.push(marker);
  });
map.addLayer(markers);

searchInput.addEventListener('keyup', () => {
  const term = searchInput.value.toLowerCase();
  markers.clearLayers();
  const matches = [];
  allMarkers.forEach(m => {
    if (m.tagName.toLowerCase().includes(term)) {
      markers.addLayer(m);
      matches.push(m);
    }
  });
  if (term && matches.length) {
    map.setView(matches[0].getLatLng(), 8);
  }
});
</script>
{% endblock %}
