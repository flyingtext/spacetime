{% extends "base.html" %}
{% block title %}{{ _('Tags') }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<div id="tag-map-container" style="position:relative;height:80vh">
  <div id="tag-icons" class="d-flex flex-wrap" style="position:absolute;top:10px;left:10px;z-index:1000;">
    {% for item in tag_info %}
      {% set tag = item.tag %}
      <button class="tag-icon btn btn-primary btn-sm me-1 mb-1" data-tag="{{ tag.name }}">{{ tag.name }}</button>
    {% endfor %}
  </div>
  <div id="tag-map" style="height:100%;"></div>
</div>
<div id="tag-results" class="mt-3"></div>
{% if not tag_info %}
<p>{{ _('No tags yet.') }}</p>
{% endif %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const tagLocations = {{ tag_locations_json|safe }};
const tagPosts = {{ tag_posts_json|safe }};
const map = L.map('tag-map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
tagLocations.forEach(t => {
  const marker = L.marker([t.lat, t.lon]).addTo(map);
  marker.bindPopup(`<a href="${t.url}">${t.name}</a>`);
});
document.querySelectorAll('.tag-icon').forEach(btn => {
  btn.addEventListener('click', () => {
    const name = btn.dataset.tag;
    const info = tagPosts.find(t => t.tag === name);
    const container = document.getElementById('tag-results');
    if(info){
      let html = `<h3>${name}</h3><ul class="list-unstyled">`;
      info.posts.forEach(p => {
        html += `<li class="mb-2"><a href="${p.url}">${p.title}</a><p class="small text-muted mb-0">${p.snippet}</p></li>`;
      });
      html += '</ul>';
      container.innerHTML = html;
      container.scrollIntoView({behavior:'smooth'});
    }
  });
});
</script>
{% endblock %}

