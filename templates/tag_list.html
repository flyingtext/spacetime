{% extends "base.html" %}
{% block title %}{{ _('Tags') }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<style>
  .container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
</style>
<div id="tag-info" class="p-3 border-bottom"></div>
<div id="tag-map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
const navHeight = document.querySelector('nav').offsetHeight;
const mapDiv = document.getElementById('tag-map');
mapDiv.style.position = 'fixed';
mapDiv.style.top = navHeight + 'px';
mapDiv.style.left = '0';
mapDiv.style.right = '0';
mapDiv.style.bottom = '0';
const infoDiv = document.getElementById('tag-info');
infoDiv.style.position = 'fixed';
infoDiv.style.top = navHeight + 'px';
infoDiv.style.left = '0';
infoDiv.style.right = '0';
infoDiv.style.background = 'rgba(255,255,255,0.9)';
infoDiv.style.zIndex = '1000';
infoDiv.style.maxHeight = '30vh';
infoDiv.style.overflowY = 'auto';
infoDiv.style.display = 'none';
infoDiv.style.color = '#000';
const tagLocations = {{ tag_locations_json|safe }};
const tagPosts = {{ tag_posts_json|safe }};
const map = L.map('tag-map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
function createIcon(name){
  const svg = `\
  <svg xmlns="http://www.w3.org/2000/svg" width="120" height="40">
    <rect width="120" height="40" rx="5" ry="5" fill="#0d6efd" fill-opacity="0.1" stroke-width="0" />
    <text x="60" y="25" font-size="14" text-anchor="middle" fill="#0d6efd">${name}</text>
  </svg>`;
  return L.divIcon({html: svg, className: '', iconSize:[120,40], iconAnchor:[60,40]});
}
const markers = L.markerClusterGroup({
  spiderLegPolylineOptions: {
    color: '#0d6efd',
    weight: 1,
    opacity: 1
  }
});
tagLocations.forEach(t => {
  const marker = L.marker([t.lat, t.lon], {icon: createIcon(t.name)});
  marker.on('click', () => {
    const info = tagPosts.find(tp => tp.tag === t.name);
    if(info){
      let html = `<h3>${t.name}</h3>`;
      info.posts.forEach(p => {
        html += `<div class="mb-2"><a href="${p.url}">${p.title}</a><div class="small text-muted">${p.author} Â· ${p.views} views</div><p class="small mb-0">${p.snippet}</p></div>`;
      });
      infoDiv.innerHTML = html;
      infoDiv.style.display = 'block';
    }
  });
  markers.addLayer(marker);
});
map.addLayer(markers);
</script>
{% endblock %}
