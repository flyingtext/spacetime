{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
<h1>{{ post.title }} ({{ post.language }})</h1>
<p><small>{{ post.path }}</small></p>
<div class="post-layout">
  {% if toc %}
  <nav class="toc-container">
    <h2>{{ _('Contents') }}</h2>
    {{ toc|safe }}
  </nav>
  {% endif %}
  <div class="post-body">{{ html_body|safe }}</div>
</div>
<p>{{ _('Tags') }}:
  {% for tag in post.tags %}
    <a href="{{ url_for('tag_filter', name=tag.name) }}">{{ tag.name }}</a>
  {% endfor %}
</p>
{% if metadata or user_metadata %}
<section>
  <h2>{{ _('Metadata') }}</h2>
  {% if metadata %}
  <h3>{{ _('Common') }}</h3>
  <ul>
    {% for key, value in metadata.items() %}
      <li><strong>{{ key }}:</strong> {{ value|format_metadata }}</li>
    {% endfor %}
  </ul>
  {% if geodata %}
  <div id="map"></div>
  {% endif %}
  {% endif %}
  {% if user_metadata %}
  <h3>{{ _('Your Metadata') }}</h3>
  <ul>
    {% for key, value in user_metadata.items() %}
      <li><strong>{{ key }}:</strong> {{ value|format_metadata }}</li>
    {% endfor %}
  </ul>
  {% endif %}
</section>
{% endif %}
{% if citations or user_citations %}
<section>
  <h2>{{ _('Citations') }}</h2>
  {% if citations %}
  <h3>{{ _('Global') }}</h3>
  <ul>
    {% for c in citations %}
      <li>
        <strong>{{ c.citation_part|format_metadata }}:</strong>
        {{ c.citation_text }}
        &mdash; <a href="{{ url_for('profile', username=c.user.username) }}">{{ c.user.username }}</a>,
        {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}
        {% if current_user.is_authenticated and (current_user.id == c.user_id or current_user.is_admin()) %}
          <a href="{{ url_for('edit_citation', post_id=post.id, cid=c.id) }}">{{ _('Edit') }}</a>
          <form action="{{ url_for('delete_citation', post_id=post.id, cid=c.id) }}" method="post" style="display:inline">
            <button type="submit">{{ _('Delete') }}</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if user_citations %}
  <h3>{{ _('Your Citations') }}</h3>
  <ul>
    {% for c in user_citations %}
      <li>
        <strong>{{ c.citation_part|format_metadata }}:</strong>
        {{ c.citation_text }}
        &mdash; <a href="{{ url_for('profile', username=c.user.username) }}">{{ c.user.username }}</a>,
        {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}
        <a href="{{ url_for('edit_citation', post_id=post.id, cid=c.id) }}">{{ _('Edit') }}</a>
        <form action="{{ url_for('delete_citation', post_id=post.id, cid=c.id) }}" method="post" style="display:inline">
          <button type="submit">{{ _('Delete') }}</button>
        </form>
      </li>
    {% endfor %}
  </ul>
  {% endif %}
</section>
{% endif %}
{% if current_user.is_authenticated %}
<section>
  <h2>{{ _('Add Citation') }}</h2>
  <form id="citation-form" action="{{ url_for('new_citation', post_id=post.id) }}" method="post">
    <p>
      <input type="text" id="citation-title" placeholder="{{ _('Title') }}" />
      <button type="button" id="fetch-citation">{{ _('Fetch Citation') }}</button>
    </p>
    <p><textarea id="citation-part" name="citation_part" placeholder="{{ _('Citation part (JSON)') }}" rows="4" cols="50"></textarea></p>
    <p><textarea id="citation-text" name="citation_text" placeholder="{{ _('Citation text') }}" rows="4" cols="50"></textarea></p>
    <p><button type="submit">{{ _('Add Citation') }}</button></p>
  </form>
  <script>
  document.getElementById('fetch-citation').addEventListener('click', function() {
      const title = document.getElementById('citation-title').value;
      fetch('{{ url_for('fetch_citation') }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({title: title})
      }).then(r => r.json())
      .then(data => {
          if (data.error) {
              alert(data.error);
              return;
          }
          document.getElementById('citation-part').value = JSON.stringify(data.part, null, 2);
          document.getElementById('citation-text').value = data.text;
      });
  });
  </script>
</section>
{% endif %}
{% if translations %}
<p>{{ _('Other languages') }}:
  {% for t in translations %}
    <a href="{{ url_for('document', language=t.language, doc_path=t.path) }}">{{ t.language }}</a>
  {% endfor %}
</p>
{% endif %}
<p>
  <a href="{{ url_for('history', post_id=post.id) }}">{{ _('History') }}</a>
  | <a href="{{ url_for('post_backlinks', post_id=post.id) }}">{{ _('Backlinks') }}</a>
  {% if current_user.is_authenticated and (current_user.id == post.author_id or current_user.is_admin()) %}
    | <a href="{{ url_for('edit_post', post_id=post.id) }}">{{ _('Edit') }}</a>
    | <form action="{{ url_for('delete_post', post_id=post.id) }}" method="post" style="display:inline">
        <button type="submit">{{ _('Delete') }}</button>
      </form>
  {% endif %}
  {% if current_user.is_authenticated %}
    {% set watching = post.watchers | selectattr('user_id', 'equalto', current_user.id) | list | length > 0 %}
    {% if watching %}
      | <form action="{{ url_for('unwatch_post', post_id=post.id) }}" method="post" style="display:inline">
        <button type="submit">{{ _('Unwatch') }}</button>
      </form>
    {% else %}
      | <form action="{{ url_for('watch_post', post_id=post.id) }}" method="post" style="display:inline">
        <button type="submit">{{ _('Watch') }}</button>
      </form>
    {% endif %}
  {% endif %}
</p>
{% if geodata %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const data = { type: 'FeatureCollection', features: {{ geodata|tojson }} };
  const map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  const layer = L.geoJSON(data).addTo(map);
  try {
    map.fitBounds(layer.getBounds());
  } catch (e) {
    // If only a single point, getBounds may return empty; fallback
    if (data.features.length > 0) {
      const c = data.features[0].geometry.coordinates;
      map.setView([c[1], c[0]], 13);
    }
  }
</script>
{% endif %}
{% endblock %}
