{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
<nav id="reading-breadcrumb" aria-label="breadcrumb" class="mb-2" style="display:none;">
  <ol class="breadcrumb mb-0"></ol>
</nav>
<div class="d-flex justify-content-between align-items-center">
  <h1 class="mb-0">{{ post.title }} ({{ post.language }})</h1>
  <div class="text-muted">
    {% if created_at %}{{ created_at.strftime('%Y-%m-%d %H:%M') }} Â· {% endif %}{{ _('Views') }}: {{ views }}
  </div>
</div>
<p><small>{{ post.path }}</small></p>
<div class="row">
  {% if toc %}
  <div class="col-md-3">
    <div class="d-none d-md-block">
      <nav class="toc-container sticky-top">
        <h2>{{ _('Contents') }}</h2>
        {{ toc|safe }}
        {% if metadata or location %}
        <h3>{{ _('Common') }}</h3>
        <table class="table table-sm">
          <tbody>
            {% for key, value in metadata.items() %}
            <tr><th scope="row">{{ key }}</th><td>{{ value|format_metadata }}</td></tr>
            {% endfor %}
            {% if location %}
            <tr>
              <th scope="row">{{ _('Location') }}</th>
              <td>
                {% if location_name %}{{ location_name }} {% endif %}
                <span class="text-muted">({{ location.lat }}, {{ location.lon }})</span>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
        {% endif %}
        {% if user_metadata %}
        <h3>{{ _('Your Metadata') }}</h3>
        <table class="table table-sm">
          <tbody>
            {% for key, value in user_metadata.items() %}
            <tr><th scope="row">{{ key }}</th><td>{{ value|format_metadata }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </nav>
    </div>
    <div class="d-md-none mb-3">
      <button class="btn btn-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas">
        {{ _('Contents') }}
      </button>
      <div class="offcanvas offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="tocOffcanvasLabel">{{ _('Contents') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{{ _('Close') }}"></button>
        </div>
        <div class="offcanvas-body">
          {{ toc|safe }}
          {% if metadata or location %}
          <h3>{{ _('Common') }}</h3>
          <table class="table table-sm">
            <tbody>
              {% for key, value in metadata.items() %}
              <tr><th scope="row">{{ key }}</th><td>{{ value|format_metadata }}</td></tr>
              {% endfor %}
              {% if location %}
              <tr>
                <th scope="row">{{ _('Location') }}</th>
                <td>
                  {% if location_name %}{{ location_name }} {% endif %}
                  <span class="text-muted">({{ location.lat }}, {{ location.lon }})</span>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
          {% endif %}
          {% if user_metadata %}
          <h3>{{ _('Your Metadata') }}</h3>
          <table class="table table-sm">
            <tbody>
              {% for key, value in user_metadata.items() %}
              <tr><th scope="row">{{ key }}</th><td>{{ value|format_metadata }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-9">
    <div class="post-body">{{ html_body|safe }}</div>
  </div>
  {% else %}
  <div class="col-md-12">
    <div class="post-body">{{ html_body|safe }}</div>
  </div>
  {% endif %}
</div>
<p>{{ _('Tags') }}:
  {% for tag in post.tags %}
    <a href="{{ url_for('tag_filter', name=tag.name) }}">{{ tag.name }}</a>
  {% endfor %}
</p>
{% if not toc and (metadata or user_metadata or location) %}
<section>
  <h2>{{ _('Metadata') }}</h2>
  {% if metadata or location %}
  <h3>{{ _('Common') }}</h3>
  <table class="table table-sm">
    <tbody>
      {% for key, value in metadata.items() %}
      <tr><th scope="row">{{ key }}</th><td>{{ value|format_metadata }}</td></tr>
      {% endfor %}
      {% if location %}
      <tr>
        <th scope="row">{{ _('Location') }}</th>
        <td>
          {% if location_name %}{{ location_name }} {% endif %}
          <span class="text-muted">({{ location.lat }}, {{ location.lon }})</span>
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>
  {% endif %}
  {% if user_metadata %}
  <h3>{{ _('Your Metadata') }}</h3>
  <table class="table table-sm">
    <tbody>
      {% for key, value in user_metadata.items() %}
      <tr><th scope="row">{{ key }}</th><td>{{ value|format_metadata }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</section>
{% endif %}
{% if location or geodata %}
<section>
  <h2>{{ _('Location') }}</h2>
  {% if location %}
  <p>
    <strong>{{ _('Location') }}:</strong>
    {% if location_name %}
      {{ location_name }}
    {% endif %}
    <span class="text-muted">({{ location.lat }}, {{ location.lon }})</span>
  </p>
  {% endif %}
  {% if geodata %}
  <div id="map"></div>
  {% endif %}
</section>
{% endif %}
{% if citations or user_citations %}
<section>
  <h2>{{ _('Citations') }}</h2>
  {% if citations %}
  <h3>{{ _('Global') }}</h3>
  <ul class="list-group">
    {% for c in citations %}
      <li class="list-group-item text-break">
        {% if c.context %}<strong>{{ c.context }}</strong> - {% endif %}
        {{ c.citation_part|mla_citation(c.doi) }}
        &mdash; <a href="{{ url_for('profile', username=c.user.username) }}">{{ c.user.username }}</a>,
        {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}
        {% if current_user.is_authenticated and (current_user.id == c.user_id or current_user.is_admin()) %}
          <a href="{{ url_for('edit_citation', post_id=post.id, cid=c.id) }}" class="btn btn-sm btn-secondary">{{ _('Edit') }}</a>
          <form action="{{ url_for('delete_citation', post_id=post.id, cid=c.id) }}" method="post" class="d-inline" onsubmit="return confirm('{{ _('Are you sure?') }}');">
            <button type="submit" class="btn btn-sm btn-danger">{{ _('Delete') }}</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if user_citations %}
  <h3>{{ _('Your Citations') }}</h3>
  <ul class="list-group">
    {% for c in user_citations %}
      <li class="list-group-item text-break">
        {% if c.context %}<strong>{{ c.context }}</strong> - {% endif %}
        {{ c.citation_part|mla_citation(c.doi) }}
        &mdash; <a href="{{ url_for('profile', username=c.user.username) }}">{{ c.user.username }}</a>,
        {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}
        <a href="{{ url_for('edit_citation', post_id=post.id, cid=c.id) }}" class="btn btn-sm btn-secondary">{{ _('Edit') }}</a>
        <form action="{{ url_for('delete_citation', post_id=post.id, cid=c.id) }}" method="post" class="d-inline" onsubmit="return confirm('{{ _('Are you sure?') }}');">
          <button type="submit" class="btn btn-sm btn-danger">{{ _('Delete') }}</button>
        </form>
      </li>
    {% endfor %}
  </ul>
  {% endif %}
</section>
{% endif %}
{% if current_user.is_authenticated %}
<section>
  <h2>{{ _('Suggest Citation') }}</h2>
  <p>{{ _('Use the buttons next to each paragraph to get suggestions.') }}</p>
</section>
<section>
  <h2>{{ _('Add Citation') }}</h2>
  <form id="citation-form" action="{{ url_for('new_citation', post_id=post.id) }}" method="post">
    <div class="mb-3 d-flex gap-2">
      <input type="text" id="citation-title" placeholder="{{ _('Title') }}" class="form-control" />
      <button type="button" id="fetch-citation" class="btn btn-secondary">{{ _('Fetch Citation') }}</button>
    </div>
    <div class="mb-3">
      <textarea id="citation-part" name="citation_part" placeholder="{{ _('Citation part (JSON)') }}" rows="4" cols="50" class="form-control"></textarea>
    </div>
    <div class="mb-3">
      <textarea id="citation-text" name="citation_text" placeholder="{{ _('Citation text') }}" rows="4" cols="50" class="form-control"></textarea>
    </div>
    <div class="mb-3 d-flex gap-2">
      <input type="url" id="citation-url" placeholder="{{ _('Citation URL') }}" class="form-control" />
      <button type="button" id="add-url-citation" class="btn btn-secondary">{{ _('Add URL Citation') }}</button>
    </div>
    <div class="mb-3">
      <input type="text" id="citation-context" name="citation_context" placeholder="{{ _('Citation context') }}" class="form-control" />
    </div>
    <div class="mb-3">
      <button type="submit" class="btn btn-primary">{{ _('Add Citation') }}</button>
    </div>
  </form>
  <script>
  const citationTitle = document.getElementById('citation-title');
  citationTitle.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('fetch-citation').click();
      }
  });
  document.getElementById('fetch-citation').addEventListener('click', function() {
      const title = document.getElementById('citation-title').value;
      fetch('{{ url_for('fetch_citation') }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({title: title})
      }).then(r => r.json())
      .then(data => {
          if (data.error) {
              alert(data.error);
              return;
          }
          document.getElementById('citation-part').value = JSON.stringify(data.part, null, 2);
          document.getElementById('citation-text').value = data.text;
      });
  });
  document.getElementById('add-url-citation').addEventListener('click', function() {
      const url = document.getElementById('citation-url').value;
      document.getElementById('citation-text').value = url;
      document.getElementById('citation-part').value = '';
      document.getElementById('citation-form').requestSubmit();
  });
  document.getElementById('citation-form').addEventListener('submit', function(e) {
      if (!confirm('{{ _('Are you sure?') }}')) {
          e.preventDefault();
          return;
      }
      showSpinner();
  });
  document.querySelectorAll('.post-body p').forEach(p => {
      const btn = document.createElement('button');
      btn.textContent = '{{ _('Suggest Citation') }}';
      btn.className = 'btn btn-sm btn-secondary ms-2';
      const result = document.createElement('div');
      btn.addEventListener('click', async () => {
          btn.disabled = true;
          const resp = await fetch('{{ url_for('citation_suggest_line') }}', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ line: p.textContent })
          });
          const data = await resp.json();
          result.innerHTML = '';
          if (data.results) {
              for (const [sentence, cands] of Object.entries(data.results)) {
                  const section = document.createElement('div');
                  const ps = document.createElement('p');
                  ps.textContent = sentence;
                  section.appendChild(ps);
                  cands.forEach(c => {
                      const container = document.createElement('div');
                      container.className = 'd-flex align-items-start gap-2 mb-2';
                      const pre = document.createElement('pre');
                      pre.textContent = c.text;
                      pre.className = 'mb-0';
                      const saveBtn = document.createElement('button');
                      saveBtn.textContent = '{{ _('Save') }}';
                      saveBtn.className = 'btn btn-sm btn-secondary';
                      saveBtn.addEventListener('click', () => {
                          const fd = new FormData();
                          fd.append('citation_text', c.text);
                          fetch('{{ url_for('new_citation', post_id=post.id) }}', {
                              method: 'POST',
                              body: fd
                          }).then(() => { saveBtn.disabled = true; });
                      });
                      container.appendChild(pre);
                      container.appendChild(saveBtn);
                      section.appendChild(container);
                  });
                  result.appendChild(section);
              }
          }
          btn.disabled = false;
      });
      p.appendChild(btn);
      p.insertAdjacentElement('afterend', result);
  });
  </script>
</section>
{% endif %}
{% if translations %}
<p>{{ _('Other languages') }}:
  {% for t in translations %}
    <a href="{{ url_for('document', language=t.language, doc_path=t.path) }}">{{ t.language }}</a>
  {% endfor %}
</p>
{% endif %}
<p>
  <a href="{{ url_for('history', post_id=post.id) }}">{{ _('History') }}</a>
  | <a href="{{ url_for('post_backlinks', post_id=post.id) }}">{{ _('Backlinks') }}</a>
  {% if current_user.is_authenticated and (current_user.id == post.author_id or current_user.is_admin()) %}
    | <a href="{{ url_for('edit_post', post_id=post.id) }}">{{ _('Edit') }}</a>
    | <form action="{{ url_for('delete_post', post_id=post.id) }}" method="post" class="d-inline" onsubmit="return confirm('{{ _('Are you sure?') }}');">
        <button type="submit" class="btn btn-link text-danger p-0">{{ _('Delete') }}</button>
      </form>
  {% endif %}
  {% if current_user.is_authenticated %}
    {% set watching = post.watchers | selectattr('user_id', 'equalto', current_user.id) | list | length > 0 %}
    {% if watching %}
      | <form action="{{ url_for('unwatch_post', post_id=post.id) }}" method="post" class="d-inline">
        <button type="submit" class="btn btn-link p-0">{{ _('Unwatch') }}</button>
      </form>
    {% else %}
      | <form action="{{ url_for('watch_post', post_id=post.id) }}" method="post" class="d-inline">
        <button type="submit" class="btn btn-link p-0">{{ _('Watch') }}</button>
      </form>
  {% endif %}
  {% endif %}
</p>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const key = 'postBreadcrumb';
  const maxItems = 10;
  const title = {{ post.title|tojson }};
  const url = window.location.pathname;
  let items;
  try {
    items = JSON.parse(localStorage.getItem(key)) || [];
  } catch (e) {
    items = [];
  }
  items = items.filter(item => item.url !== url);
  items.push({ title, url });
  if (items.length > maxItems) {
    items = items.slice(items.length - maxItems);
  }
  localStorage.setItem(key, JSON.stringify(items));
  const nav = document.getElementById('reading-breadcrumb');
  const ol = nav ? nav.querySelector('ol') : null;
  if (nav && ol && items.length > 0) {
    nav.style.display = 'block';
    items.forEach((item, index) => {
      const li = document.createElement('li');
      li.classList.add('breadcrumb-item');
      if (index === items.length - 1) {
        li.textContent = item.title;
        li.classList.add('active');
        li.setAttribute('aria-current', 'page');
      } else {
        const a = document.createElement('a');
        a.href = item.url;
        a.textContent = item.title;
        li.appendChild(a);
      }
      ol.appendChild(li);
    });
  }
});
</script>
{% if geodata %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const data = { type: 'FeatureCollection', features: {{ geodata|tojson }} };
  const map = L.map('map').setView([0, 0], 2);
  const darkUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
  const lightUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  const isDark = () => document.body.classList.contains('dark-mode') || localStorage.getItem('theme') === 'dark';
  const tiles = L.tileLayer(isDark() ? darkUrl : lightUrl, {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  const updateTiles = () => {
      tiles.setUrl(isDark() ? darkUrl : lightUrl);
  };
  const themeToggle = document.getElementById('theme-toggle');
  if (themeToggle) {
      themeToggle.addEventListener('click', () => setTimeout(updateTiles, 0));
  }
  const layer = L.geoJSON(data).addTo(map);
  try {
    map.fitBounds(layer.getBounds());
  } catch (e) {
    // If only a single point, getBounds may return empty; fallback
    if (data.features.length > 0) {
      const c = data.features[0].geometry.coordinates;
      map.setView([c[1], c[0]], 13);
    }
  }
</script>
{% endif %}
{% endblock %}
