{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
<h1>{{ post.title }} ({{ post.language }})</h1>
<p><small>{{ post.path }}</small></p>
<div>{{ html_body|safe }}</div>
<p>Tags:
  {% for tag in post.tags %}
    <a href="{{ url_for('tag_filter', name=tag.name) }}">{{ tag.name }}</a>
  {% endfor %}
</p>
{% if metadata or user_metadata %}
<section>
  <h2>Metadata</h2>
  {% if metadata %}
  <h3>Common</h3>
  <ul>
    {% for key, value in metadata.items() %}
      <li><strong>{{ key }}:</strong> {{ value|format_metadata }}</li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if user_metadata %}
  <h3>Your Metadata</h3>
  <ul>
    {% for key, value in user_metadata.items() %}
      <li><strong>{{ key }}:</strong> {{ value|format_metadata }}</li>
    {% endfor %}
  </ul>
  {% endif %}
</section>
{% endif %}
{% if citations or user_citations %}
<section>
  <h2>Citations</h2>
  {% if citations %}
  <h3>Global</h3>
  <ul>
    {% for c in citations %}
      <li>
        <strong>{{ c.citation_part|format_metadata }}:</strong>
        {{ c.citation_text }}
        &mdash; {{ c.user.username }},
        {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}
        {% if current_user.is_authenticated and (current_user.id == c.user_id or current_user.is_admin()) %}
          <a href="{{ url_for('edit_citation', post_id=post.id, cid=c.id) }}">Edit</a>
          <form action="{{ url_for('delete_citation', post_id=post.id, cid=c.id) }}" method="post" style="display:inline">
            <button type="submit">Delete</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if user_citations %}
  <h3>Your Citations</h3>
  <ul>
    {% for c in user_citations %}
      <li>
        <strong>{{ c.citation_part|format_metadata }}:</strong>
        {{ c.citation_text }}
        &mdash; {{ c.user.username }},
        {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}
        <a href="{{ url_for('edit_citation', post_id=post.id, cid=c.id) }}">Edit</a>
        <form action="{{ url_for('delete_citation', post_id=post.id, cid=c.id) }}" method="post" style="display:inline">
          <button type="submit">Delete</button>
        </form>
      </li>
    {% endfor %}
  </ul>
  {% endif %}
</section>
{% endif %}
{% if current_user.is_authenticated %}
<section>
  <h2>Add Citation</h2>
  <form id="citation-form" action="{{ url_for('new_citation', post_id=post.id) }}" method="post">
    <p>
      <input type="text" id="citation-title" placeholder="Title" />
      <button type="button" id="fetch-citation">Fetch Citation</button>
    </p>
    <p><textarea id="citation-part" name="citation_part" placeholder="Citation part (JSON)" rows="4" cols="50"></textarea></p>
    <p><textarea id="citation-text" name="citation_text" placeholder="Citation text" rows="4" cols="50"></textarea></p>
    <p><button type="submit">Add Citation</button></p>
  </form>
  <script>
  document.getElementById('fetch-citation').addEventListener('click', function() {
      const title = document.getElementById('citation-title').value;
      fetch('{{ url_for('fetch_citation') }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({title: title})
      }).then(r => r.json())
      .then(data => {
          if (data.error) {
              alert(data.error);
              return;
          }
          document.getElementById('citation-part').value = JSON.stringify(data.part, null, 2);
          document.getElementById('citation-text').value = data.text;
      });
  });
  </script>
</section>
{% endif %}
{% if translations %}
<p>Other languages:
  {% for t in translations %}
    <a href="{{ url_for('document', language=t.language, doc_path=t.path) }}">{{ t.language }}</a>
  {% endfor %}
</p>
{% endif %}
<p>
  <a href="{{ url_for('history', post_id=post.id) }}">History</a>
  {% if current_user.is_authenticated and (current_user.id == post.author_id or current_user.is_admin()) %}
    | <a href="{{ url_for('edit_post', post_id=post.id) }}">Edit</a>
  {% endif %}
  {% if current_user.is_authenticated %}
    {% set watching = post.watchers | selectattr('user_id', 'equalto', current_user.id) | list | length > 0 %}
    {% if watching %}
      | <form action="{{ url_for('unwatch_post', post_id=post.id) }}" method="post" style="display:inline">
        <button type="submit">Unwatch</button>
      </form>
    {% else %}
      | <form action="{{ url_for('watch_post', post_id=post.id) }}" method="post" style="display:inline">
        <button type="submit">Watch</button>
      </form>
    {% endif %}
  {% endif %}
</p>
{% endblock %}
