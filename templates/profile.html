{% extends "base.html" %}
{% block title %}{{ user.username }}{% endblock %}
{% block content %}
<h1>{{ user.username }}</h1>
<p>{{ user.bio }}</p>
{% if user.locale %}<p>{{ _('Locale') }}: {{ user.locale }}</p>{% endif %}
{% if user.timezone %}<p>{{ _('Timezone') }}: {{ user.timezone }}</p>{% endif %}
{% if user.distance_unit %}<p>{{ _('Distance Unit') }}: {{ user.distance_unit }}</p>{% endif %}
<section>
  <h2>{{ _('Contribution Metrics') }}</h2>
  <div class="row row-cols-1 row-cols-sm-2 g-4">
    <div class="col">
      <div class="card text-center h-100">
        <div class="card-body">
          <h5 class="card-title">{{ _('Posts') }}</h5>
          <p class="card-text">{{ post_count }}</p>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card text-center h-100">
        <div class="card-body">
          <h5 class="card-title">{{ _('Citations') }}</h5>
          <p class="card-text">{{ citation_count }}</p>
        </div>
      </div>
    </div>
  </div>
</section>
<section>
  <h2>{{ _('Recent Posts') }}</h2>
  <div class="row row-cols-1 row-cols-md-2 g-4">
  {% for p in posts %}
    <div class="col">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title"><a href="{{ url_for('document', language=p.language, doc_path=p.path) }}">{{ p.display_title }}</a></h5>
          <p class="card-text">{{ p.path }} ({{ p.language }})</p>
        </div>
      </div>
    </div>
  {% else %}
    <p>{{ _('No posts yet.') }}</p>
  {% endfor %}
  </div>
</section>
<section>
  <h2>{{ _('Edited Posts') }}</h2>
  <div class="row row-cols-1 row-cols-md-2 g-4">
  {% for p in edited_posts %}
    <div class="col">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title"><a href="{{ url_for('document', language=p.language, doc_path=p.path) }}">{{ p.display_title }}</a></h5>
          <p class="card-text">{{ p.path }} ({{ p.language }})</p>
        </div>
      </div>
    </div>
  {% else %}
    <p>{{ _('No edits yet.') }}</p>
  {% endfor %}
  </div>
</section>
{% if post_locations %}
<section>
  <h2>{{ _('Contribution Map') }}</h2>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <div id="profile-map" style="height: 400px;"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const postLocations = {{ post_locations_json|safe }};
    const map = L.map('profile-map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markers = [];
    postLocations.forEach(p => {
      const m = L.marker([p.lat, p.lon]).addTo(map);
      m.bindPopup(`<a href="${p.url}">${p.title}</a>`);
      markers.push(m);
    });
    if (markers.length === 1) {
      map.setView(markers[0].getLatLng(), 8);
    } else if (markers.length > 1) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  </script>
</section>
{% endif %}
{% if current_user.is_authenticated and current_user.id == user.id %}
<section>
  <h2>{{ _('Edit Profile') }}</h2>
  <form method="post">
    <div class="mb-3">
      <textarea name="bio" placeholder="{{ _('Bio') }}" rows="4" cols="50" class="form-control">{{ user.bio or '' }}</textarea>
    </div>
    <div class="mb-3">
      <label for="locale" class="form-label">{{ _('Locale') }}</label>
      <select name="locale" id="locale" class="form-select">
        {% for lang in languages %}
        <option value="{{ lang }}" {% if user.locale == lang %}selected{% endif %}>{{ lang }}</option>
        {% endfor %}
      </select>
    </div>
      <div class="mb-3">
        <label for="timezone" class="form-label">{{ _('Timezone') }}</label>
        <input type="text" id="timezone" name="timezone" class="form-control" value="{{ user.timezone or '' }}">
      </div>
      <div class="mb-3">
        <label for="distance_unit" class="form-label">{{ _('Distance Unit') }}</label>
        <select id="distance_unit" name="distance_unit" class="form-select">
          <option value="km" {% if user.distance_unit != 'mi' %}selected{% endif %}>{{ _('Kilometers') }}</option>
          <option value="mi" {% if user.distance_unit == 'mi' %}selected{% endif %}>{{ _('Miles') }}</option>
        </select>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="tag_modal_new_tab" name="tag_modal_new_tab" {% if user.tag_modal_new_tab %}checked{% endif %}>
        <label class="form-check-label" for="tag_modal_new_tab">{{ _('Open tag links in new tab') }}</label>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="keyword_highlight_plugin" name="keyword_highlight_plugin" {% if user.keyword_highlight_plugin %}checked{% endif %}>
        <label class="form-check-label" for="keyword_highlight_plugin">{{ _('Enable keyword sentence highlight') }}</label>
      </div>
    <div class="mb-3">
      <button type="submit" class="btn btn-primary">{{ _('Update') }}</button>
    </div>
  </form>
</section>
{% endif %}
{% endblock %}
