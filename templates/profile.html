{% extends "base.html" %}
{% block title %}{{ user.username }}{% endblock %}
{% block content %}
<h1>{{ user.username }}</h1>
<p>{{ user.bio }}</p>
<section>
  <h2>{{ _('Contribution Metrics') }}</h2>
  <ul class="list-group">
    <li class="list-group-item">{{ _('Posts') }}: {{ post_count }}</li>
    <li class="list-group-item">{{ _('Citations') }}: {{ citation_count }}</li>
  </ul>
</section>
<section>
  <h2>{{ _('Recent Posts') }}</h2>
  <ul class="list-group">
  {% for p in posts %}
    <li class="list-group-item"><a href="{{ url_for('document', language=p.language, doc_path=p.path) }}">{{ p.title }}</a></li>
  {% else %}
    <li class="list-group-item">{{ _('No posts yet.') }}</li>
  {% endfor %}
  </ul>
</section>
<section>
  <h2>{{ _('Edited Posts') }}</h2>
  <ul class="list-group">
  {% for p in edited_posts %}
    <li class="list-group-item"><a href="{{ url_for('document', language=p.language, doc_path=p.path) }}">{{ p.title }}</a></li>
  {% else %}
    <li class="list-group-item">{{ _('No edits yet.') }}</li>
  {% endfor %}
  </ul>
</section>
{% if post_locations %}
<section>
  <h2>{{ _('Contribution Map') }}</h2>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <div id="profile-map" style="height: 400px;"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const postLocations = {{ post_locations_json|safe }};
    const map = L.map('profile-map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markers = [];
    postLocations.forEach(p => {
      const m = L.marker([p.lat, p.lon]).addTo(map);
      m.bindPopup(`<a href="${p.url}">${p.title}</a>`);
      markers.push(m);
    });
    if (markers.length === 1) {
      map.setView(markers[0].getLatLng(), 8);
    } else if (markers.length > 1) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  </script>
</section>
{% endif %}
{% if current_user.is_authenticated and current_user.id == user.id %}
<section>
  <h2>{{ _('Edit Profile') }}</h2>
  <form method="post">
    <div class="mb-3">
      <textarea name="bio" placeholder="{{ _('Bio') }}" rows="4" cols="50" class="form-control">{{ user.bio or '' }}</textarea>
    </div>
    <div class="mb-3">
      <button type="submit" class="btn btn-primary">{{ _('Update') }}</button>
    </div>
  </form>
</section>
{% endif %}
{% endblock %}
